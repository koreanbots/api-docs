# 웹후크

<Message type="info">디스코드 웹후크를 사용하시는 경우 아래 모든 내용은 유효하지 않습니다.</Message>

- 문서의 다른 정보와 달리 웹후크의 경우 클라이언트가 서버로 요청을 보내는 것이 아닌 서버가 클라이언트로 요청을 보내는 것이므로 참고하실 때 유의해주시기 바랍니다.

## 웹후크 주소 검증 절차

- 한디리는 등록하려는 웹후크 주소가 유효한지 확인하기 위해 웹후크 주소에 `GET` 요청을 보냅니다.  
해당 요청에는 검증된 웹후크를 수신하는 데 필요한 시크릿 키가 포함됩니다.
- 요청을 받은 서버에서 후술하는 바와 같이 응답해야 웹후크가 등록됩니다.

### `GET`

#### Query String

| FIELD | TYPE | DESCRIPTION |
| --- | --- | --- |
| secret* | string | 시크릿 키 |

- ``secret``에 제공되는 문자열은 수신한 웹후크가 한디리에서 보낸 유효한 웹후크인지 확인할 때 사용할 수 있습니다.  

#### 응답

```tsx
{
	secret: SECRET
}
```

#### 요청 예시

`GET` /?secret=66682ec7-cccd-4640-8df3-601e3e43060f

#### 응답 예시

```json
{
	"secret": "66682ec7-cccd-4640-8df3-601e3e43060f"
}
```

<Message type=”warning”>

응답에 실패한 경우 `웹후크 주소를 검증할 수 없습니다.` 라고 표시되며, 봇 또는 서버 정보 수정이 이루어지지 않습니다.

</Message>

## 웹후크 정보

### 구조

| FIELD | TYPE | DESCRIPTION |
| --- | --- | --- |
| type | string | 웹후크 이벤트의 타입 |
| data | object | 웹후크 데이터 |
| timestamp* | number | 웹후크 이벤트가 발생한 시각 |

- ``timestamp``는 UNIX Epoch로부터 경과한 밀리초 시간입니다.

## 웹후크 이벤트 타입(type)

| VALUE | DESCRIPTION |
| --- | --- |
| bot | 봇 |
| server | 서버 |

## 웹후크 데이터

### 구조

| FIELD | TYPE | DESCRIPTION |
| --- | --- | --- |
| type | integer | 웹후크 데이터의 타입 |
| botId? | string | 봇의 웹후크인 경우 봇 ID |
| guildId? | string | 서버의 웹후크인 경우 서버 ID |
| before | ?integer | 데이터의 변동 전의 값 |
| after | integer | 데이터의 변동 후의 값 |
| userId* | string | 하트 수 변동일 경우 하트를 추가한 유저의 ID |

- ``userId``는 웹후크의 type이 ``0``인 경우에만 제공됩니다.

## 웹후크 데이터 구분(type)

| VALUE | DESCRIPTION |
| --- | --- |
| 0 | 하트 수 변동 |
| 1 | 서버 수 변동 |

## 웹후크 이벤트
- 한디리에서 보내는 웹후크는 `POST` 요청으로 보내집니다.

### 웹후크에 대한 응답
- 보낸 웹후크에 대한 응답은 다음과 같이 이루어져야 하며, 한디리가 보낸 요청에 응답하지 않거나 올바르지 않게 응답한 경우 웹후크가 **비활성화**됩니다.
- 한디리가 보낸 요청에 ``10``초 안으로 응답하지 않은 경우 웹후크는 응답하지 않은 것으로 간주됩니다.

|구분|내용|
|---|---|
|응답 코드|`2xx`|
|응답 본문|빈 문자열|

- `4xx` 형식의 응답 코드를 반환한 경우 웹후크는 **즉시** 비활성화됩니다.
- 응답 본문이 비어있지 않은 경우 웹후크는 **즉시** 비활성화됩니다.
- 이외의 다른 비정상 반환이 발생할 경우 한디리에서는 웹후크 재전송을 시도합니다. 웹후크 재전송에 관한 내용은 [아래](#실패한-웹후크-재전송)를 참조해주세요.

### 웹후크 내용 검증하기
- 웹후크가 한디리에서 보낸 것인지 검증하려면 최초에 한디리가 보낸 `GET` 요청에 포함되었던 시크릿 키를 사용해야 합니다.
- 해당 시크릿 키는 매 요청마다 `secret` 헤더에 포함되어 전송됩니다.

#### 하트 추가 이벤트 예시

```json
{
    "type": "server",
	"data": {
        "type": 0,
        "guildId": "653083797763522580",
        "before": 0,
        "after": 1,
        "userId": "288302173912170497"
    },
    "timestamp": 1682252410000
}
```

#### 서버 수 변동 이벤트 예시

```json
{
	"type": "bot",
	"data": {
        "type": 1,
        "botId": "872349051620831292",
        "before": 1000,
        "after": 1001
    },
    "timestamp": 1682252410000
}
```

## 실패한 웹후크 재전송
- 한디리는 전송에 실패한 웹후크에 대해 총 10번의 재전송을 시도합니다.  
처음 재전송은 최초 실패시부터 ``4``초 후에 이루어지며, 재전송이 실패할 때마다 재전송 간격이 ``2``배씩 증가하며, 최대 ``4096``초까지 증가합니다.
- 10번의 재전송이 모두 실패한 경우 해당 웹후크는 다시 받을 수 없습니다.
- 처음 10번의 재전송이 모두 실패한 이후로 ``24``시간 이상 웹후크 전송이 지속적으로 실패한 경우 경우 웹후크가 **비활성화**됩니다.